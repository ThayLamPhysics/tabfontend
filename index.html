<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tr√¨nh t·∫°o m√£ Web App Ki·ªÉm tra ver 3</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Nunito', sans-serif;
            background-color: #0f172a;
            color: #e2e8f0;
        }
        .glass-card {
            background: rgba(30, 41, 59, 0.6);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(56, 189, 248, 0.2);
            transition: all 0.3s ease;
        }
        .neon-button {
            background-color: #0ea5e9;
            color: #ffffff;
            box-shadow: 0 0 5px #0ea5e9, 0 0 15px #0ea5e9;
            transition: all 0.3s ease;
        }
        .neon-button:hover:not(:disabled) {
            box-shadow: 0 0 10px #0ea5e9, 0 0 25px #0ea5e9;
        }
        .copy-button {
            background-color: #10b981;
        }
        .download-button {
            background-color: #3b82f6;
        }
        textarea {
            background-color: #1e293b;
            border-color: #38bdf8;
            color: #e2e8f0;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-4">

    <div class="w-full max-w-4xl mx-auto">
        <div class="glass-card p-8 rounded-2xl text-center">
            <h1 class="text-4xl font-bold text-sky-300 mb-2">Tr√¨nh t·∫°o m√£ Web App Ki·ªÉm tra ver 3</h1>
            <p class="text-sky-100 mb-6">Nh·∫≠p c√°c th√¥ng tin d∆∞·ªõi ƒë√¢y ƒë·ªÉ t·∫°o m√£ HTML ho√†n ch·ªânh.</p>
            
            <div class="space-y-4 mb-6">
                 <input type="text" id="quiz-title-input" placeholder="Nh·∫≠p t√™n b√†i ki·ªÉm tra (v√≠ d·ª•: B√†i 15 ph√∫t V·∫≠t L√Ω)" class="w-full p-3 rounded-lg bg-slate-800 border border-sky-500 text-white focus:outline-none focus:ring-2 focus:ring-sky-300 text-center">
                <input type="url" id="script-url-input" placeholder="D√°n link Google Apps Script v√†o ƒë√¢y..." class="w-full p-3 rounded-lg bg-slate-800 border border-sky-500 text-white focus:outline-none focus:ring-2 focus:ring-sky-300 text-center">
            </div>
            <button id="generate-button" class="w-full max-w-md mx-auto neon-button font-bold py-3 px-8 rounded-lg text-lg">T·∫°o m√£</button>


            <div id="output-container" class="hidden text-left mt-8">
                <div class="flex justify-between items-center mb-2">
                    <label for="code-output" class="font-bold text-sky-300">M√£ HTML ƒë√£ t·∫°o:</label>
                    <div class="flex items-center gap-2">
                        <button id="copy-button" class="copy-button text-white font-bold py-2 px-4 rounded-lg text-sm">Sao ch√©p</button>
                        <button id="download-button" class="download-button text-white font-bold py-2 px-4 rounded-lg text-sm">T·∫£i xu·ªëng</button>
                    </div>
                </div>
                <textarea id="code-output" readonly class="w-full h-64 p-3 rounded-lg border focus:outline-none focus:ring-2"></textarea>
            </div>
        </div>
    </div>

    <script>
        const scriptUrlInput = document.getElementById('script-url-input');
        const quizTitleInput = document.getElementById('quiz-title-input');
        const generateButton = document.getElementById('generate-button');
        const outputContainer = document.getElementById('output-container');
        const codeOutput = document.getElementById('code-output');
        const copyButton = document.getElementById('copy-button');
        const downloadButton = document.getElementById('download-button');

        // This is the template of the quiz app. The placeholder will be replaced.
        const htmlTemplate = `
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>%%QUIZ_TITLE%%</title>
    <script src="https://cdn.tailwindcss.com"><\/script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"><\/script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    <!-- Th∆∞ vi·ªán KaTeX ƒë·ªÉ hi·ªÉn th·ªã c√¥ng th·ª©c to√°n -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"><\/script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"><\/script>
    <style>
        body {
            font-family: 'Nunito', sans-serif;
            background-color: #020a18;
            color: #e0f7fa;
        }
        .glass-card {
            background: rgba(2, 25, 58, 0.6);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(0, 245, 255, 0.2);
            transition: all 0.3s ease;
        }
        .neon-button {
            background-color: #00f5ff;
            color: #020a18;
            box-shadow: 0 0 5px #00f5ff, 0 0 15px #00f5ff, 0 0 25px #00f5ff;
            transition: all 0.3s ease;
        }
        .neon-button:hover:not(:disabled) {
            box-shadow: 0 0 10px #00f5ff, 0 0 25px #00f5ff, 0 0 50px #00f5ff;
        }
        .neon-button:disabled {
            background-color: #374151;
            color: #9ca3af;
            box-shadow: none;
            cursor: not-allowed;
        }
        .submit-button {
            background-color: #22c55e;
            color: white;
            box-shadow: 0 0 5px #22c55e, 0 0 15px #22c55e;
        }
         .submit-button:hover:not(:disabled) {
            box-shadow: 0 0 10px #22c55e, 0 0 25px #22c55e;
        }
        .cancel-button {
             background-color: #6b7280;
        }
        .cancel-button:hover:not(:disabled) {
             background-color: #4b5563;
        }
        .progress-bar-inner {
            background: linear-gradient(90deg, #00f5ff, #00a2ff);
            transition: width 0.5s ease-in-out;
        }
        .option-button, .mtf-button {
            border: 1px solid #00a2ff;
            transition: all 0.2s ease;
        }
        .option-button:hover, .mtf-button:hover {
            background-color: rgba(0, 162, 255, 0.3);
            border-color: #00f5ff;
        }
        .option-button.selected, .mtf-button.selected {
            background-color: #00f5ff;
            color: #020a18;
            border-color: #00f5ff;
        }
        .correct {
            background-color: rgba(34, 197, 94, 0.2);
            border-left: 4px solid #22c55e;
        }
        .incorrect {
            background-color: rgba(239, 68, 68, 0.2);
            border-left: 4px solid #ef4444;
        }
        .hard-question {
            border: 2px solid #ef4444;
            box-shadow: 0 0 15px rgba(239, 68, 68, 0.5);
        }
        .comprehension-question {
            border: 2px solid #f59e0b;
            box-shadow: 0 0 15px rgba(245, 158, 11, 0.5);
        }
        .loader {
            border: 5px solid #1e293b;
            border-top: 5px solid #00f5ff;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #fireworks-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 100;
        }
        /* KaTeX styling */
        .katex { font-size: 1.1em; }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-4">
    <canvas id="fireworks-canvas"></canvas>
    <div id="app-container" class="w-full max-w-4xl mx-auto">

        <!-- M√†n h√¨nh b·∫Øt ƒë·∫ßu -->
        <div id="start-screen" class="glass-card p-8 rounded-2xl text-center">
            <h1 class="text-4xl font-bold text-cyan-300 mb-2">%%QUIZ_TITLE%%</h1>
            <p class="text-cyan-100 mb-6">Ch√†o m·ª´ng b·∫°n ƒë·∫øn v·ªõi h·ªá th·ªëng luy·ªán t·∫≠p th√¥ng minh!</p>
            <div class="max-w-md mx-auto">
                <input type="text" id="student-name" placeholder="Nh·∫≠p h·ªç v√† t√™n c·ªßa b·∫°n..." class="w-full p-3 rounded-lg bg-slate-800 border border-cyan-500 text-white focus:outline-none focus:ring-2 focus:ring-cyan-300 mb-4 text-center">
                <button id="start-button" class="w-full neon-button font-bold py-3 px-6 rounded-lg text-lg">B·∫Øt ƒë·∫ßu l√†m b√†i</button>
                <p class="text-xs text-cyan-400 mt-2">L∆∞u √Ω: T√™n s·∫Ω ƒë∆∞·ª£c t·ª± ƒë·ªông ƒë·ªãnh d·∫°ng vi·∫øt hoa ch·ªØ c√°i ƒë·∫ßu.</p>
            </div>
            <div class="mt-8 text-left text-sm text-cyan-200 bg-slate-800/50 p-4 rounded-lg">
                <h3 class="font-bold text-cyan-300 mb-2">üí° Ch·∫ø ƒë·ªô Th√≠ch ·ª©ng Ho·∫°t ƒë·ªông nh∆∞ th·∫ø n√†o?</h3>
                <p>Khi b·∫°n nh·∫≠p t√™n, h·ªá th·ªëng s·∫Ω t√¨m ki·∫øm ƒëi·ªÉm s·ªë c√°c b√†i l√†m tr∆∞·ªõc c·ªßa b·∫°n trong Google Sheet. D·ª±a tr√™n k·∫øt qu·∫£ ƒë√≥, s·ªë l∆∞·ª£ng c√¢u h·ªèi s·∫Ω ƒë∆∞·ª£c ƒëi·ªÅu ch·ªânh:</p>
                <ul class="list-disc list-inside mt-2">
                    <li>N·∫øu k·∫øt qu·∫£ t·ªët, b·∫°n s·∫Ω l√†m s·ªë c√¢u h·ªèi c∆° b·∫£n.</li>
                    <li>N·∫øu k·∫øt qu·∫£ ch∆∞a cao, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông th√™m c√°c c√¢u h·ªèi c·ªßng c·ªë ƒë·ªÉ gi√∫p b·∫°n √¥n t·∫≠p k·ªπ h∆°n.</li>
                    <li>N·∫øu kh√¥ng t√¨m th·∫•y t√™n b·∫°n, h·ªá th·ªëng s·∫Ω ƒë∆∞a ra m·ªôt s·ªë c√¢u h·ªèi m·∫∑c ƒë·ªãnh.</li>
                </ul>
            </div>
        </div>

        <!-- M√†n h√¨nh l√†m b√†i -->
        <div id="quiz-screen" class="hidden">
            <div class="flex justify-between items-center mb-4">
                <h2 id="question-counter" class="text-xl font-bold text-cyan-300">C√¢u 1 / 15</h2>
                <div id="subject-badge" class="bg-cyan-500 text-slate-900 font-bold px-3 py-1 rounded-full text-sm"></div>
            </div>
            <div class="w-full bg-slate-700 rounded-full h-2.5 mb-6">
                <div id="progress-bar" class="progress-bar-inner h-2.5 rounded-full" style="width: 0%"></div>
            </div>
            <div id="question-card" class="glass-card p-8 rounded-2xl">
                <div class="flex items-start justify-between">
                    <p id="question-text" class="text-2xl font-semibold mb-2 flex-grow"></p>
                    <div id="question-icons" class="ml-4 flex-shrink-0 flex items-center gap-2"></div>
                </div>
                <div id="question-image-container" class="my-4 flex justify-center"></div>
                <div id="answer-options" class="space-y-3 mt-4"></div>
                
                <div id="navigation-buttons" class="flex justify-between items-center mt-8 space-x-4">
                    <button id="previous-button" class="flex-1 neon-button font-bold py-3 px-6 rounded-lg text-lg">C√¢u tr∆∞·ªõc</button>
                    <button id="submit-quiz-button" class="flex-1 submit-button font-bold py-3 px-6 rounded-lg text-lg">N·ªôp B√†i</button>
                    <button id="next-button" class="flex-1 neon-button font-bold py-3 px-6 rounded-lg text-lg">C√¢u sau</button>
                </div>
            </div>
        </div>

        <!-- M√†n h√¨nh k·∫øt qu·∫£ -->
        <div id="results-screen" class="hidden">
            <div class="glass-card p-8 rounded-2xl text-center">
                <h2 class="text-4xl font-bold text-cyan-300 mb-2">K·∫øt qu·∫£: %%QUIZ_TITLE%%</h2>
                <p id="feedback-comment" class="text-lg text-cyan-100 mb-4"></p>
                <div class="flex justify-center items-baseline gap-4 mb-6">
                    <p class="text-6xl font-extrabold text-white"><span id="correct-count">0</span>/<span id="total-count">0</span></p>
                    <p class="text-3xl font-bold text-cyan-400">(<span id="percentage">0</span>%)</p>
                </div>
                
                <div id="score-by-subject" class="flex flex-wrap justify-center gap-4 mb-6"></div>

                <div id="ai-analysis-container" class="text-left bg-slate-800/50 p-6 rounded-lg my-6">
                    <h3 class="text-xl font-bold text-cyan-300 mb-3">üë®‚Äçüè´ Nh·∫≠n x√©t t·ª´ Th·∫ßy L√¢m:</h3>
                    <p id="ai-analysis" class="text-cyan-100 whitespace-pre-wrap"></p>
                </div>

                <div id="summary-link-container" class="my-6 hidden">
                     <a id="summary-link" href="#" target="_blank" class="inline-block bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-8 rounded-lg transition-colors">
                        üìÑ Xem & T·∫£i v·ªÅ Chi ti·∫øt B√†i l√†m
                    </a>
                </div>

                <div id="detailed-results" class="mt-8 text-left space-y-4"></div>
                <button id="restart-button" class="w-full max-w-md mx-auto mt-8 neon-button font-bold py-3 px-6 rounded-lg text-lg">L√†m l·∫°i b√†i kh√°c</button>
            </div>
        </div>
    </div>

    <!-- Ph√¢n v√πng T∆∞∆°ng t√°c AI -->
    <div id="ai-interaction-section" class="hidden w-full max-w-4xl mx-auto mt-6 glass-card rounded-2xl shadow-2xl">
        <div class="p-4 border-b border-cyan-500/30">
            <h3 class="font-bold text-lg text-cyan-300">H·ªèi ƒë√°p c√πng Th·∫ßy L√¢m üë®‚Äçüè´</h3>
            <p class="text-sm text-cyan-200">B·∫°n c√≥ th·∫Øc m·∫Øc v·ªÅ c√°c c√¢u ƒë√£ l√†m sai? H√£y h·ªèi ·ªü ƒë√¢y.</p>
        </div>
        <div id="ai-chat-messages" class="p-4 h-48 overflow-y-auto">
            <!-- Messages will be appended here -->
        </div>
        <div class="p-4 border-t border-cyan-500/30 flex gap-2">
            <input type="text" id="ai-chat-input" placeholder="Nh·∫≠p c√¢u h·ªèi..." class="flex-grow p-2 rounded-lg bg-slate-800 border border-cyan-500 text-white focus:outline-none focus:ring-2 focus:ring-cyan-300">
            <button id="ai-chat-send" class="bg-cyan-500 text-slate-900 font-bold px-4 rounded-lg hover:bg-cyan-400 transition-colors">G·ª≠i</button>
        </div>
    </div>


    <!-- M√†n h√¨nh Loading -->
    <div id="loading-overlay" class="hidden fixed inset-0 bg-slate-900/80 flex flex-col items-center justify-center z-50">
        <div class="loader"></div>
        <p id="loading-text" class="text-cyan-300 mt-4 text-lg">ƒêang t·∫£i c√¢u h·ªèi...</p>
    </div>

    <!-- Custom Confirmation Modal -->
    <div id="confirm-modal" class="hidden fixed inset-0 bg-slate-900/80 flex items-center justify-center z-50">
        <div class="glass-card p-8 rounded-2xl text-center max-w-md w-full mx-4">
            <h3 class="text-2xl font-bold text-cyan-300 mb-4">X√°c nh·∫≠n N·ªôp b√†i</h3>
            <p id="confirm-modal-text" class="text-cyan-100 mb-8"></p>
            <div class="flex justify-center gap-4">
                <button id="confirm-modal-cancel" class="flex-1 neon-button cancel-button font-bold py-3 px-6 rounded-lg text-lg">Quay l·∫°i</button>
                <button id="confirm-modal-ok" class="flex-1 submit-button font-bold py-3 px-6 rounded-lg text-lg">N·ªôp b√†i</button>
            </div>
        </div>
    </div>


    <script>
        // ===================================================================================
        // C·∫§U H√åNH QUAN TR·ªåNG
        // ===================================================================================
        const WEB_APP_URL = '%%SCRIPT_URL_PLACEHOLDER%%'; // <--- THIS IS A PLACEHOLDER
        // ===================================================================================

        // DOM Elements
        const startScreen = document.getElementById('start-screen');
        const quizScreen = document.getElementById('quiz-screen');
        const resultsScreen = document.getElementById('results-screen');
        const loadingOverlay = document.getElementById('loading-overlay');
        const loadingText = document.getElementById('loading-text');

        const studentNameInput = document.getElementById('student-name');
        const startButton = document.getElementById('start-button');
        const previousButton = document.getElementById('previous-button');
        const nextButton = document.getElementById('next-button');
        const submitQuizButton = document.getElementById('submit-quiz-button');
        const restartButton = document.getElementById('restart-button');

        const questionCounter = document.getElementById('question-counter');
        const subjectBadge = document.getElementById('subject-badge');
        const progressBar = document.getElementById('progress-bar');
        const questionCard = document.getElementById('question-card');
        const questionText = document.getElementById('question-text');
        const questionIcons = document.getElementById('question-icons');
        const questionImageContainer = document.getElementById('question-image-container');
        const answerOptions = document.getElementById('answer-options');

        const correctCountEl = document.getElementById('correct-count');
        const totalCountEl = document.getElementById('total-count');
        const percentageEl = document.getElementById('percentage');
        const feedbackCommentEl = document.getElementById('feedback-comment');
        const scoreBySubjectEl = document.getElementById('score-by-subject');
        const aiAnalysisEl = document.getElementById('ai-analysis');
        const detailedResultsEl = document.getElementById('detailed-results');
        const summaryLinkContainer = document.getElementById('summary-link-container');
        const summaryLink = document.getElementById('summary-link');

        const aiInteractionSection = document.getElementById('ai-interaction-section');
        const aiChatMessages = document.getElementById('ai-chat-messages');
        const aiChatInput = document.getElementById('ai-chat-input');
        const aiChatSend = document.getElementById('ai-chat-send');
        
        const fireworksCanvas = document.getElementById('fireworks-canvas');
        
        const confirmModal = document.getElementById('confirm-modal');
        const confirmModalText = document.getElementById('confirm-modal-text');
        const confirmModalCancel = document.getElementById('confirm-modal-cancel');
        const confirmModalOk = document.getElementById('confirm-modal-ok');

        // App State
        let state = {
            studentName: '',
            questions: [],
            currentQuestionIndex: 0,
            answers: [],
            correctAnswers: [],
            questionStartTime: 0,
            subjectNames: {
                'physics': 'V·∫≠t L√Ω',
                'chemistry': 'H√≥a H·ªçc',
                'biology': 'Sinh H·ªçc'
            }
        };

        // Event Listeners
        startButton.addEventListener('click', startQuiz);
        previousButton.addEventListener('click', handlePreviousQuestion);
        nextButton.addEventListener('click', handleNextQuestion);
        submitQuizButton.addEventListener('click', confirmAndSubmitQuiz);
        restartButton.addEventListener('click', () => location.reload());
        aiChatSend.addEventListener('click', sendAIChat);
        aiChatInput.addEventListener('keyup', (e) => {
            if (e.key === 'Enter') sendAIChat();
        });
        
        confirmModalCancel.addEventListener('click', () => {
            confirmModal.classList.add('hidden');
            submitQuizButton.disabled = false;
        });

        confirmModalOk.addEventListener('click', () => {
            confirmModal.classList.add('hidden');
            submitQuiz();
        });

        // Functions
        function formatStudentName(name) {
            if (!name) return '';
            return name
                .toLowerCase()
                .split(' ')
                .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                .join(' ');
        }

        function apiCall(action, payload) {
            try {
                return fetch(WEB_APP_URL, {
                    method: 'POST',
                    mode: 'cors',
                    redirect: 'follow',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify({ action, ...payload })
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('L·ªói m·∫°ng ho·∫∑c URL kh√¥ng h·ª£p l·ªá: ' + response.statusText);
                    }
                    return response.json();
                });
            } catch (error) {
                console.error('L·ªói API:', error);
                alert('Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn m√°y ch·ªß. Vui l√≤ng ki·ªÉm tra l·∫°i URL Web App v√† ƒë·∫£m b·∫£o ƒë√£ tri·ªÉn khai script ch√≠nh x√°c.\\nChi ti·∫øt: ' + error.message);
                return Promise.reject({ error: error.message });
            }
        }

        function showLoading(message) {
            loadingText.textContent = message;
            loadingOverlay.classList.remove('hidden');
            loadingOverlay.classList.add('flex');
        }

        function hideLoading() {
            loadingOverlay.classList.add('hidden');
            loadingOverlay.classList.remove('flex');
        }

        async function startQuiz() {
            const rawName = studentNameInput.value.trim();
            if (!rawName) {
                alert('Vui l√≤ng nh·∫≠p h·ªç v√† t√™n c·ªßa b·∫°n.');
                return;
            }
            
            const formattedName = formatStudentName(rawName);
            studentNameInput.value = formattedName;
            state.studentName = formattedName;

            showLoading('ƒêang t·∫£i c√¢u h·ªèi theo tr√¨nh ƒë·ªô c·ªßa b·∫°n...');

            try {
                const payload = {
                    studentName: state.studentName,
                    adaptiveMode: true
                };
                const data = await apiCall('getQuestions', payload);

                if (data.error || !data.questions || data.questions.length === 0) {
                    alert('Kh√¥ng th·ªÉ t·∫£i c√¢u h·ªèi. Vui l√≤ng th·ª≠ l·∫°i.');
                    return;
                }

                state.questions = data.questions;
                state.currentQuestionIndex = 0;
                // Kh·ªüi t·∫°o m·∫£ng state.answers ngay sau khi load c√¢u h·ªèi
                state.answers = new Array(state.questions.length).fill(null);
                startScreen.classList.add('hidden');
                quizScreen.classList.remove('hidden');
                renderQuestion();
            } catch (error) {
                // Error is already handled in apiCall
            } finally {
                hideLoading();
            }
        }

        function renderQuestion() {
            const question = state.questions[state.currentQuestionIndex];
            
            questionCounter.textContent = 'C√¢u ' + (state.currentQuestionIndex + 1) + ' / ' + state.questions.length;
            progressBar.style.width = (((state.currentQuestionIndex + 1) / state.questions.length) * 100) + '%';
            
            const subjectKey = question.subject;
            const subjectName = state.subjectNames[subjectKey] || subjectKey.charAt(0).toUpperCase() + subjectKey.slice(1);
            subjectBadge.textContent = subjectName;

            applyQuestionStyles(question);
            
            answerOptions.innerHTML = '';

            switch (question.type) {
                case 'group':
                    questionText.innerHTML = question.groupPrompt || 'Tr·∫£ l·ªùi c√°c m·ªánh ƒë·ªÅ sau:';
                    questionImageContainer.innerHTML = ''; // Groups don't have a single image
                    
                    const savedGroupAnswer = state.answers[state.currentQuestionIndex]?.answer || [];

                    question.subQuestions.forEach((subQ, index) => {
                        const statementDiv = document.createElement('div');
                        statementDiv.className = 'mtf-statement flex items-center justify-between p-3 border-t border-cyan-500/20';
                        
                        const statementText = document.createElement('p');
                        statementText.innerHTML = subQ.question;
                        statementText.className = 'flex-grow mr-4';
                        statementDiv.appendChild(statementText);

                        const buttonGroup = document.createElement('div');
                        buttonGroup.className = 'flex gap-2 flex-shrink-0';
                        
                        const trueBtn = document.createElement('button');
                        trueBtn.textContent = 'ƒê√∫ng';
                        trueBtn.className = 'mtf-button p-2 rounded-md text-sm w-20';
                        trueBtn.dataset.value = 'true';
                        
                        const falseBtn = document.createElement('button');
                        falseBtn.textContent = 'Sai';
                        falseBtn.className = 'mtf-button p-2 rounded-md text-sm w-20';
                        falseBtn.dataset.value = 'false';

                        if (savedGroupAnswer[index] === true) {
                            trueBtn.classList.add('selected');
                        } else if (savedGroupAnswer[index] === false) {
                            falseBtn.classList.add('selected');
                        }

                        trueBtn.onclick = () => {
                            trueBtn.classList.add('selected');
                            falseBtn.classList.remove('selected');
                        };
                        falseBtn.onclick = () => {
                            falseBtn.classList.add('selected');
                            trueBtn.classList.remove('selected');
                        };

                        buttonGroup.appendChild(trueBtn);
                        buttonGroup.appendChild(falseBtn);
                        statementDiv.appendChild(buttonGroup);
                        answerOptions.appendChild(statementDiv);
                    });
                    break;
                
                default: // Handles mc, tf, fib
                    questionText.innerHTML = question.question;
                    questionImageContainer.innerHTML = '';
                    if (question.imageUrl) {
                        const img = document.createElement('img');
                        img.src = question.imageUrl;
                        img.alt = 'H√¨nh ·∫£nh minh h·ªça';
                        img.className = 'max-h-72 w-auto mx-auto my-4 rounded-lg shadow-lg';
                        questionImageContainer.appendChild(img);
                    }
                    renderSingleAnswerOptions(question);
                    break;
            }
            
            updateNavButtons();
            state.questionStartTime = Date.now();
            if (window.renderMathInElement) {
                renderMathInElement(questionCard, {
                    delimiters: [
                        {left: '$$', right: '$$', display: true},
                        {left: '$', right: '$', display: false}
                    ]
                });
            }
        }

        function renderSingleAnswerOptions(question) {
             const savedAnswer = state.answers[state.currentQuestionIndex];
             switch (question.type) {
                case 'mc':
                    question.options.forEach((option, index) => {
                        const button = document.createElement('button');
                        button.className = 'w-full p-4 rounded-lg text-left option-button';
                        button.innerHTML = option;
                        button.dataset.answer = index;
                        button.onclick = () => selectAnswer(button, true);
                        if (savedAnswer && savedAnswer.answer === index) {
                            button.classList.add('selected');
                        }
                        answerOptions.appendChild(button);
                    });
                    break;
                case 'tf':
                     const trueButton = document.createElement('button');
                    trueButton.className = 'w-full p-4 rounded-lg text-left option-button';
                    trueButton.textContent = 'ƒê√∫ng';
                    trueButton.dataset.answer = 'true';
                    trueButton.onclick = () => selectAnswer(trueButton, true);
                    if (savedAnswer && savedAnswer.answer === true) {
                        trueButton.classList.add('selected');
                    }
                    answerOptions.appendChild(trueButton);
                    
                    const falseButton = document.createElement('button');
                    falseButton.className = 'w-full p-4 rounded-lg text-left option-button';
                    falseButton.textContent = 'Sai';
                    falseButton.dataset.answer = 'false';
                    falseButton.onclick = () => selectAnswer(falseButton, true);
                     if (savedAnswer && savedAnswer.answer === false) {
                        falseButton.classList.add('selected');
                    }
                    answerOptions.appendChild(falseButton);
                    break;
                case 'fib':
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.className = 'w-full p-3 rounded-lg bg-slate-800 border border-cyan-500 text-white focus:outline-none focus:ring-2 focus:ring-cyan-300';
                    input.placeholder = 'Nh·∫≠p c√¢u tr·∫£ l·ªùi c·ªßa b·∫°n...';
                    input.id = 'fib-input';
                    if (savedAnswer) {
                        input.value = savedAnswer.answer;
                    }
                    answerOptions.appendChild(input);
                    break;
            }
        }

        function applyQuestionStyles(question) {
            questionCard.classList.remove('hard-question', 'comprehension-question');
            questionIcons.innerHTML = '';

            if (question.cognitiveLevel === 'high-order-application' || question.cognitiveLevel === 'application' || question.difficulty === 'hard') {
                questionCard.classList.add('hard-question');
            } else if (question.cognitiveLevel === 'comprehension') {
                questionCard.classList.add('comprehension-question');
            }

            if (question.cognitiveLevel === 'high-order-application') {
                const starIcon = document.createElement('span');
                starIcon.innerHTML = '‚≠ê';
                starIcon.title = 'C√¢u h·ªèi v·∫≠n d·ª•ng cao';
                starIcon.className = 'text-2xl';
                questionIcons.appendChild(starIcon);
            }
            if (question.requiresCalculation) {
                const calcIcon = document.createElement('span');
                calcIcon.innerHTML = 'üñ©';
                calcIcon.title = 'C√¢u h·ªèi n√†y c·∫ßn t√≠nh to√°n';
                calcIcon.className = 'text-2xl';
                questionIcons.appendChild(calcIcon);
            }
        }


        function updateNavButtons() {
            previousButton.disabled = state.currentQuestionIndex === 0;
            nextButton.disabled = state.currentQuestionIndex === state.questions.length - 1;
        }

        function saveCurrentAnswer() {
            const question = state.questions[state.currentQuestionIndex];
            let studentAnswer;

            switch (question.type) {
                case 'group':
                    const answers = [];
                    const statementDivs = answerOptions.querySelectorAll('.mtf-statement');
                    statementDivs.forEach(div => {
                        const selectedBtn = div.querySelector('.selected');
                        if (selectedBtn) {
                            answers.push(selectedBtn.dataset.value === 'true');
                        } else {
                            answers.push(null);
                        }
                    });
                    studentAnswer = answers;
                    break;
                case 'mc':
                case 'tf':
                    const selectedOption = answerOptions.querySelector('.selected');
                    if (selectedOption) {
                        studentAnswer = selectedOption.dataset.answer;
                        if (question.type === 'mc') studentAnswer = parseInt(studentAnswer, 10);
                        if (question.type === 'tf') studentAnswer = (studentAnswer === 'true');
                    }
                    break;
                case 'fib':
                    const input = document.getElementById('fib-input');
                    if (input && input.value.trim()) {
                       studentAnswer = input.value.trim();
                    }
                    break;
            }
            
            if (studentAnswer !== undefined) {
                const timeTakenThisSession = Math.round((Date.now() - state.questionStartTime) / 1000);
                const existingAnswer = state.answers[state.currentQuestionIndex];
                
                if (existingAnswer == null) { // B·∫Øt c·∫£ null v√† undefined
                    state.answers[state.currentQuestionIndex] = {
                        id: question.id,
                        answer: studentAnswer,
                        timeTaken: timeTakenThisSession
                    };
                } else {
                    existingAnswer.answer = studentAnswer;
                    existingAnswer.timeTaken += timeTakenThisSession;
                }
            }
        }

        function handleNextQuestion() {
            saveCurrentAnswer();
            if (state.currentQuestionIndex < state.questions.length - 1) {
                state.currentQuestionIndex++;
                renderQuestion();
            }
        }

        function handlePreviousQuestion() {
            saveCurrentAnswer();
            if (state.currentQuestionIndex > 0) {
                state.currentQuestionIndex--;
                renderQuestion();
            }
        }

        function confirmAndSubmitQuiz() {
            submitQuizButton.disabled = true;

            // L∆∞u l·∫°i c√¢u hi·ªán t·∫°i
            saveCurrentAnswer();

            // ƒê·ª£i 1 frame ƒë·ªÉ ch·∫Øc ch·∫Øn state ƒë√£ ·ªïn ƒë·ªãnh tr∆∞·ªõc khi hi·ªÉn th·ªã modal
            requestAnimationFrame(() => {
                const unansweredCount = state.answers.filter(a => a === null).length;
                let confirmationMessage = "B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën n·ªôp b√†i kh√¥ng?";
                if (unansweredCount > 0) {
                    confirmationMessage += '<br><br><span class="text-yellow-400 font-semibold">C·∫£nh b√°o: B·∫°n c√≤n ' + unansweredCount + ' c√¢u ch∆∞a tr·∫£ l·ªùi.</span>';
                }

                confirmModalText.innerHTML = confirmationMessage;
                confirmModal.classList.remove('hidden');
            });
        }
        
        async function submitQuiz() {
            submitQuizButton.textContent = 'ƒêang n·ªôp b√†i...';
            confirmModalOk.disabled = true;
            showLoading('ƒêang ch·∫•m b√†i v√† ph√¢n t√≠ch k·∫øt qu·∫£...');

            // ‚ú® FIX: Thay th·∫ø gi√° tr·ªã null b·∫±ng m·ªôt ƒë·ªëi t∆∞·ª£ng gi·ªØ ch·ªó an to√†n
            const processedAnswers = state.answers.map((ans, index) => {
                if (ans === null) {
                    return {
                        id: state.questions[index].id,
                        answer: 'NO_ANSWER', // M·ªôt chu·ªói ƒë·∫∑c bi·ªát ƒë·ªÉ backend nh·∫≠n di·ªán
                        timeTaken: 0
                    };
                }
                return ans;
            });

            try {
                const payload = {
                    studentName: state.studentName,
                    answers: processedAnswers, // S·ª≠ d·ª•ng m·∫£ng ƒë√£ ƒë∆∞·ª£c x·ª≠ l√Ω
                    questionIds: state.questions.map(q => q.id)
                };
                const results = await apiCall('submitQuiz', payload);
                
                if (results.error) {
                    alert('C√≥ l·ªói x·∫£y ra khi n·ªôp b√†i: ' + results.error);
                    submitQuizButton.disabled = false;
                    submitQuizButton.textContent = 'N·ªôp B√†i';
                    confirmModalOk.disabled = false;
                    return;
                }

                state.correctAnswers = results.correctAnswers;
                quizScreen.classList.add('hidden');
                resultsScreen.classList.remove('hidden');
                displayResults(results);
            } catch (error) {
                submitQuizButton.disabled = false;
                submitQuizButton.textContent = 'N·ªôp B√†i';
                confirmModalOk.disabled = false;
            } finally {
                 hideLoading();
            }
        }

        function displayResults(results) {
            aiInteractionSection.classList.remove('hidden'); // Show AI section on results screen
            correctCountEl.textContent = results.correctCount;
            totalCountEl.textContent = results.total;
            percentageEl.textContent = results.percentage;
            feedbackCommentEl.textContent = results.feedbackComment;
            aiAnalysisEl.textContent = results.analysis || "Kh√¥ng c√≥ ph√¢n t√≠ch t·ª´ AI.";

            if (results.summaryFileUrl) {
                summaryLink.href = results.summaryFileUrl;
                summaryLinkContainer.classList.remove('hidden');
            }

            if (results.percentage === 100) {
                triggerFireworks();
            }

            scoreBySubjectEl.innerHTML = '';
            for (const subjectKey in results.scoresBySubject) {
                const scoreData = results.scoresBySubject[subjectKey];
                const subjectName = state.subjectNames[subjectKey] || subjectKey;
                const div = document.createElement('div');
                div.className = 'glass-card p-3 rounded-lg';
                div.innerHTML = '<span class="font-bold text-cyan-300">' + subjectName + ':</span> <span class="text-white">' + scoreData.correct + '/' + scoreData.total + '</span>';
                scoreBySubjectEl.appendChild(div);
            }

            detailedResultsEl.innerHTML = '<h3 class="text-2xl font-bold text-cyan-300 mb-4 text-center">Xem l·∫°i b√†i l√†m</h3>';
            
            state.questions.forEach((q, index) => {
                const resultDiv = document.createElement('div');
                const studentAnswerData = state.answers[index];
                const correctAnswerData = state.correctAnswers.find(ca => ca.id === q.id);
                let studentAnswerText = '<i>Ch∆∞a tr·∫£ l·ªùi</i>';
                let isCorrect = false;

                if (studentAnswerData && correctAnswerData) {
                    const studentAns = studentAnswerData.answer;
                    const correctAns = correctAnswerData.correctAnswer;
                    
                    if (q.type === 'group') {
                        isCorrect = JSON.stringify(studentAns) === JSON.stringify(correctAns);
                        studentAnswerText = '<ul class="list-disc list-inside text-left">';
                        q.subQuestions.forEach((subQ, i) => {
                           const studentChoice = studentAns[i] === true ? 'ƒê√∫ng' : (studentAns[i] === false ? 'Sai' : 'Ch∆∞a ch·ªçn');
                           studentAnswerText += '<li>' + subQ.question + ' -> <strong>' + studentChoice + '</strong></li>';
                        });
                        studentAnswerText += '</ul>';
                    } else if (q.type === 'mc') {
                        studentAnswerText = q.options[studentAns] || 'L·ª±a ch·ªçn kh√¥ng h·ª£p l·ªá';
                        if (String(studentAns) === String(correctAns)) isCorrect = true;
                    } else if (q.type === 'tf') {
                        studentAnswerText = studentAns ? 'ƒê√∫ng' : 'Sai';
                        if (studentAns === correctAns) isCorrect = true;
                    } else {
                        studentAnswerText = studentAns;
                        if (String(studentAns).trim().toLowerCase() == String(correctAns).trim().toLowerCase()) isCorrect = true;
                    }
                }
                
                let correctAnswerText = '';
                if(correctAnswerData) {
                    const correctAns = correctAnswerData.correctAnswer;
                    if (q.type === 'group') {
                        correctAnswerText = '<ul class="list-disc list-inside text-left">';
                        q.subQuestions.forEach((subQ, i) => {
                           const correctChoice = correctAns[i] ? 'ƒê√∫ng' : 'Sai';
                           correctAnswerText += '<li>' + subQ.question + ' -> <strong>' + correctChoice + '</strong></li>';
                        });
                        correctAnswerText += '</ul>';
                    } else if (q.type === 'mc') {
                        correctAnswerText = q.options[correctAns];
                    } else if (q.type === 'tf') {
                        correctAnswerText = correctAns ? 'ƒê√∫ng' : 'Sai';
                    } else {
                        correctAnswerText = correctAns;
                    }
                }

                let cardClasses = 'p-4 rounded-lg mb-3';
                cardClasses += isCorrect ? ' correct' : ' incorrect';
                resultDiv.className = cardClasses;

                const questionTitle = q.type === 'group' ? q.groupPrompt : q.question;

                let innerHTML = '<p class="font-bold mb-2">C√¢u ' + (index + 1) + ' (ID: ' + q.id + '): ' + questionTitle + '</p>';
                innerHTML += '<div class="text-sm">C√¢u tr·∫£ l·ªùi c·ªßa b·∫°n: <div class="text-white">' + studentAnswerText + '</div></div>';
                if (!isCorrect) {
                    innerHTML += '<div class="text-sm mt-2">ƒê√°p √°n ƒë√∫ng: <div class="text-green-400">' + correctAnswerText + '</div></div>';
                }
                resultDiv.innerHTML = innerHTML;

                detailedResultsEl.appendChild(resultDiv);
            });
             if (window.renderMathInElement) {
                renderMathInElement(detailedResultsEl, {
                    delimiters: [
                        {left: '$$', right: '$$', display: true},
                        {left: '$', right: '$', display: false}
                    ]
                });
            }
        }

        function selectAnswer(selectedButton, isMultipleChoice) {
            if (isMultipleChoice) {
                const buttons = answerOptions.querySelectorAll('.option-button');
                buttons.forEach(btn => btn.classList.remove('selected'));
            }
            selectedButton.classList.add('selected');
        }

        function triggerFireworks() {
            const duration = 5 * 1000;
            const animationEnd = Date.now() + duration;
            const defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 100 };

            function randomInRange(min, max) {
                return Math.random() * (max - min) + min;
            }

            const interval = setInterval(function() {
                const timeLeft = animationEnd - Date.now();

                if (timeLeft <= 0) {
                    return clearInterval(interval);
                }

                const particleCount = 50 * (timeLeft / duration);
                confetti({ ...defaults, particleCount, origin: { x: randomInRange(0.1, 0.3), y: Math.random() - 0.2 } });
                confetti({ ...defaults, particleCount, origin: { x: randomInRange(0.7, 0.9), y: Math.random() - 0.2 } });
            }, 250);
        }

        async function sendAIChat() {
            const question = aiChatInput.value.trim();
            if (!question) return;
            
            const currentQuestion = state.questions[state.currentQuestionIndex];
            const subject = currentQuestion ? currentQuestion.subject : 'physics';

            addMessageToChat('user', question);
            aiChatInput.value = '';
            aiChatInput.disabled = true;
            aiChatSend.disabled = true;

            try {
                const payload = { question, subject };
                const response = await apiCall('askAI', payload);
                addMessageToChat('ai', response.answer || 'R·∫•t ti·∫øc, t√¥i kh√¥ng th·ªÉ tr·∫£ l·ªùi c√¢u h·ªèi n√†y l√∫c n√†y.');
            } catch(error) {
                addMessageToChat('ai', 'L·ªói k·∫øt n·ªëi ƒë·∫øn tr·ª£ l√Ω AI.');
            } finally {
                aiChatInput.disabled = false;
                aiChatSend.disabled = false;
                aiChatInput.focus();
            }
        }

        function addMessageToChat(sender, text) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'mb-3 ' + (sender === 'user' ? 'text-right' : 'text-left');
            const bubble = document.createElement('div');
            bubble.className = 'inline-block p-3 rounded-2xl max-w-[80%] ' + (sender === 'user' ? 'bg-cyan-600 text-white rounded-br-none' : 'bg-slate-700 text-cyan-100 rounded-bl-none');
            bubble.textContent = text;
            messageDiv.appendChild(bubble);
            aiChatMessages.appendChild(messageDiv);
            aiChatMessages.scrollTop = aiChatMessages.scrollHeight;
             if (window.renderMathInElement) {
                renderMathInElement(bubble, {
                    delimiters: [
                        {left: '$$', right: '$$', display: true},
                        {left: '$', right: '$', display: false}
                    ]
                });
            }
        }

    <\/script>
</body>
</html>
`;

        generateButton.addEventListener('click', () => {
            const url = scriptUrlInput.value.trim();
            const title = quizTitleInput.value.trim() || 'B√†i Ki·ªÉm Tra T∆∞∆°ng T√°c';

            if (!url || !url.startsWith('https://script.google.com/macros/s/')) {
                alert('Vui l√≤ng nh·∫≠p m·ªôt URL Google Apps Script h·ª£p l·ªá.');
                return;
            }

            // Replace the placeholders with the user's URL and title
            let finalCode = htmlTemplate.replace(/%%SCRIPT_URL_PLACEHOLDER%%/g, url);
            finalCode = finalCode.replace(/%%QUIZ_TITLE%%/g, title);
            
            codeOutput.value = finalCode.trim();
            outputContainer.classList.remove('hidden');
        });

        copyButton.addEventListener('click', () => {
            codeOutput.select();
            codeOutput.setSelectionRange(0, 99999); // For mobile devices

            try {
                // Use execCommand as a fallback for iFrame environments
                document.execCommand('copy');
                copyButton.textContent = 'ƒê√£ sao ch√©p!';
                setTimeout(() => {
                    copyButton.textContent = 'Sao ch√©p';
                }, 2000);
            } catch (err) {
                alert('Kh√¥ng th·ªÉ sao ch√©p t·ª± ƒë·ªông. Vui l√≤ng sao ch√©p th·ªß c√¥ng.');
            }
        });

        downloadButton.addEventListener('click', () => {
            const code = codeOutput.value;
            if (!code) {
                alert('Ch∆∞a c√≥ m√£ ƒë·ªÉ t·∫£i xu·ªëng. Vui l√≤ng t·∫°o m√£ tr∆∞·ªõc.');
                return;
            }

            const blob = new Blob([code], { type: 'text/html' });
            const url = URL.createObjectURL(blob);

            const a = document.createElement('a');
            a.href = url;
            a.download = 'index.html';
            document.body.appendChild(a);
            a.click();
            
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });

    </script>
</body>
</html>

